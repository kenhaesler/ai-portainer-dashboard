## Edge-focused observer load testing
#
# Prerequisites:
#   1) Dev stack running:
#      docker compose -f docker/docker-compose.dev.yml up -d
#   2) At least one Edge endpoint enrolled (optional, but recommended):
#      docker compose -f docker/docker-compose.edge-agent.yml up -d
#
# Run:
#   npm run loadtest:edge
#   npm run loadtest:edge:multi
#
# Or directly:
#   docker compose -f docker/docker-compose.edge-loadtest.yml run --rm edge-observer-a
#   docker compose -f docker/docker-compose.edge-loadtest.yml up --build --scale edge-observer-a=3 --scale edge-observer-b=3 --abort-on-container-exit edge-observer-a edge-observer-b

x-edge-observer: &edge-observer
  build:
    context: ../loadtests
    dockerfile: ../docker/loadtests/Dockerfile
  image: aidash-loadtest
  environment:
    BASE_URL: http://backend:3051
    DASHBOARD_USER: ${LOADTEST_USER:-admin}
    DASHBOARD_PASS: ${LOADTEST_PASS:-changeme123}
  command: ["npx", "artillery", "run", "artillery-edge-observer.yml"]
  networks:
    - dashboard-net

services:
  edge-observer-a:
    <<: *edge-observer

  edge-observer-b:
    <<: *edge-observer

networks:
  dashboard-net:
    external: true
    name: ai-portainer-dashboard_dashboard-net
